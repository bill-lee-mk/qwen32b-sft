# 训练流水线配置
sft_enabled: true
dpo_enabled: true
sft_data_path: "/home/ubuntu/lilei/projects/qwen32b-sft/processed_training_data/sft_data.jsonl"
dpo_data_path: "/home/ubuntu/lilei/projects/qwen32b-sft/processed_training_data/dpo_data.jsonl"
final_model_dir: "/home/ubuntu/lilei/projects/qwen32b-sft/models/qwen3-32B/final_model"
use_checkpoint: false
checkpoint_dir: null

# 模型配置
model_config:
#  model_name: "Qwen/Qwen2.5-32B-Instruct"
  model_name: "Qwen/Qwen3-32B"
  model_revision: null
  tokenizer_name: null
  torch_dtype: "bfloat16"
  device_map: "auto"
  trust_remote_code: true
  use_flash_attention: true
  flash_attention_type: "flash_attention_3"
  gradient_checkpointing: true

# SFT训练配置
sft_config:
  output_dir: "/home/ubuntu/lilei/projects/qwen32b-sft/models/qwen3-32B/sft_model"
  num_train_epochs: 2
  per_device_train_batch_size: 1
  gradient_accumulation_steps: 8
  learning_rate: 1.0e-5
  warmup_steps: 100
  logging_steps: 10
  save_steps: 1000
  save_total_limit: 2
  eval_strategy: "no"
  fp16: false
  bf16: true    # Flash Attention 3支持BF16
  optim: "adamw_torch"
  lr_scheduler_type: "cosine"
  weight_decay: 0.02
  max_grad_norm: 1.0
  seed: 42
  dataloader_num_workers: 4
  remove_unused_columns: true
  group_by_length: true
  max_length: 8192    # SFT 单条样本最大 token 数，可调
  report_to: "tensorboard"
  deepspeed: "configs/deepspeed_config.json"


# Flash Attention特定配置
flash_attention:
  enabled: true
  causal: true
  softmax_scale: null  # 自动计算
  dropout: 0.0
  deterministic: false
  backend: "CUTLASS"


# DPO训练配置
dpo_config:
  output_dir: "/home/ubuntu/lilei/projects/qwen32b-sft/models/qwen3-32B/dpo_model"
  num_train_epochs: 1
  per_device_train_batch_size: 1
  gradient_accumulation_steps: 16  # 从32降低到16，减少内存累积
  learning_rate: 3.0e-6
  warmup_steps: 100
  logging_steps: 10
  save_steps: 200 
  save_total_limit: 3
  eval_strategy: "no"  # 暂时禁用评估，避免评估时OOM（训练稳定后再启用）
  # eval_steps: 500  # 评估已禁用 
  fp16: false
  bf16: true
  beta: 0.05
  label_smoothing: 0.0
  loss_type: "sigmoid"
  optim: "adamw_torch"
  lr_scheduler_type: "cosine"
  weight_decay: 0.01
  max_grad_norm: 0.5
  max_length: 2048
  max_prompt_length: 2048
  seed: 42
  dataloader_num_workers: 2  # 从4降低到2，避免多GPU环境下的死锁问题
  remove_unused_columns: false
  report_to: "tensorboard"
  deepspeed: "configs/deepspeed_config.json"
